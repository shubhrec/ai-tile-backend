# Tiles API Setup Guide

Quick guide to set up the user-specific tiles persistence feature.

## 1. Run Database Migration

### Option A: Supabase Dashboard (Easiest)

1. Open your Supabase dashboard: https://app.supabase.com
2. Go to **SQL Editor**
3. Click **New Query**
4. Copy the contents of `migrations/001_create_tiles_table.sql`
5. Paste and click **Run**

### Option B: Copy-Paste SQL

```sql
-- Create tiles table
CREATE TABLE IF NOT EXISTS tiles (
    id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    user_id UUID NOT NULL REFERENCES auth.users(id) ON DELETE CASCADE,
    name TEXT NOT NULL DEFAULT '',
    image_url TEXT NOT NULL,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW() NOT NULL
);

-- Add indexes
CREATE INDEX IF NOT EXISTS idx_tiles_user_id ON tiles(user_id);
CREATE INDEX IF NOT EXISTS idx_tiles_created_at ON tiles(created_at DESC);

-- Enable RLS
ALTER TABLE tiles ENABLE ROW LEVEL SECURITY;

-- RLS Policies
CREATE POLICY "Users can view own tiles"
    ON tiles FOR SELECT
    USING (auth.uid() = user_id);

CREATE POLICY "Users can insert own tiles"
    ON tiles FOR INSERT
    WITH CHECK (auth.uid() = user_id);

CREATE POLICY "Users can update own tiles"
    ON tiles FOR UPDATE
    USING (auth.uid() = user_id)
    WITH CHECK (auth.uid() = user_id);

CREATE POLICY "Users can delete own tiles"
    ON tiles FOR DELETE
    USING (auth.uid() = user_id);
```

## 2. Verify Setup

The code is already integrated! The tiles API is now available at:

- `POST /api/tiles` - Add a new tile
- `GET /api/tiles` - Get user's tiles

## 3. Test the API

### Get a JWT Token

```javascript
// In your frontend
const { data } = await supabase.auth.getSession();
const token = data.session?.access_token;
console.log('Token:', token);
```

### Test Adding a Tile

```bash
export TOKEN="your-jwt-token-here"

curl -X POST http://localhost:8000/api/tiles \
  -H "Authorization: Bearer $TOKEN" \
  -H "Content-Type: application/json" \
  -d '{
    "image_url": "https://waqzrjsczmlvkapbkcno.supabase.co/storage/v1/object/public/tiles/test.jpg",
    "name": "Test Tile"
  }'
```

Expected response:
```json
{
  "success": true,
  "tile": {
    "id": 1,
    "user_id": "...",
    "name": "Test Tile",
    "image_url": "https://...",
    "created_at": "2025-10-22T..."
  }
}
```

### Test Getting Tiles

```bash
curl -X GET http://localhost:8000/api/tiles \
  -H "Authorization: Bearer $TOKEN"
```

Expected response:
```json
{
  "tiles": [
    {
      "id": 1,
      "user_id": "...",
      "name": "Test Tile",
      "image_url": "https://...",
      "created_at": "2025-10-22T..."
    }
  ]
}
```

## 4. Frontend Integration

See `TILES_API_DOCS.md` for complete frontend examples including:

- React hooks for managing tiles
- Complete upload workflow
- Error handling
- TypeScript types

## 5. Verify RLS is Working

### Test 1: Access Own Tiles (Should Work)

```bash
# Get tiles with valid token
curl -X GET http://localhost:8000/api/tiles \
  -H "Authorization: Bearer $TOKEN"

# Should return your tiles
```

### Test 2: Access Without Auth (Should Fail)

```bash
# Try without token
curl -X GET http://localhost:8000/api/tiles

# Should return 401 Unauthorized
```

### Test 3: Insert with Auth (Should Work)

```bash
# Add tile with valid token
curl -X POST http://localhost:8000/api/tiles \
  -H "Authorization: Bearer $TOKEN" \
  -H "Content-Type: application/json" \
  -d '{"image_url": "https://example.com/tile.jpg", "name": "My Tile"}'

# Should succeed
```

## 6. Check Database

Verify data in Supabase dashboard:

1. Go to **Table Editor**
2. Select `tiles` table
3. You should see your tiles with correct user_id

## Complete Workflow Example

```typescript
// 1. Upload tile image
const formData = new FormData();
formData.append('file', tileFile);

const uploadRes = await fetch('/api/upload/tiles', {
  method: 'POST',
  headers: { 'Authorization': `Bearer ${token}` },
  body: formData
});
const { url: imageUrl } = await uploadRes.json();

// 2. Save tile to database
const addRes = await fetch('/api/tiles', {
  method: 'POST',
  headers: {
    'Authorization': `Bearer ${token}`,
    'Content-Type': 'application/json'
  },
  body: JSON.stringify({
    image_url: imageUrl,
    name: 'My Custom Tile'
  })
});
const { tile } = await addRes.json();

// 3. Retrieve all tiles
const getRes = await fetch('/api/tiles', {
  headers: { 'Authorization': `Bearer ${token}` }
});
const { tiles } = await getRes.json();

console.log('User has', tiles.length, 'tiles');
```

## Troubleshooting

### Migration Fails

**Error:** `relation "auth.users" does not exist`

**Solution:** Make sure you're running the migration on your Supabase project, not a local database.

### RLS Policy Violations

**Error:** `new row violates row-level security policy`

**Solution:**
1. Verify JWT token is valid
2. Check `auth.uid()` returns the correct user ID
3. Ensure user exists in `auth.users` table

### No Tiles Returned

**Possible causes:**
1. User hasn't added any tiles yet (normal)
2. Different user_id in token vs database
3. RLS blocking access (check policies)

**Debug:**
```sql
-- Check user's tiles directly in SQL editor
SELECT * FROM tiles WHERE user_id = 'your-user-id-here';
```

## Summary

âœ… Database migration completed
âœ… API endpoints registered
âœ… Authentication working
âœ… RLS enabled and tested
âœ… Ready for production use

Your tiles API is now live and ready to use! ðŸš€
